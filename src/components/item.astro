---
import '../assets/item.css'
import 'prismjs/themes/prism.css'
import dayjs from '../lib/dayjs'
import { getEnv } from '../lib/env'
import voidFile from '../assets/void.png'

const locale = getEnv(import.meta.env, Astro, 'LOCALE')
const timezone = getEnv(import.meta.env, Astro, 'TIMEZONE')

locale && dayjs.locale(locale)

const { SITE_URL } = Astro.locals
const { post, isItem, channel: channelInfo } = Astro.props

const channel = getEnv(import.meta.env, Astro, 'CHANNEL')
const COMMENTS = getEnv(import.meta.env, Astro, 'COMMENTS')
const staticProxy = getEnv(import.meta.env, Astro, 'STATIC_PROXY') ?? '/static/'

const avatarSrc = channelInfo?.avatar?.startsWith('http')
  ? `${staticProxy}${channelInfo?.avatar}`
  : (channelInfo?.avatar ?? voidFile.src)
const channelName = channelInfo?.title ?? getEnv(import.meta.env, Astro, 'CHANNEL_NAME') ?? channel ?? 'Channel'

const datetime = dayjs(post.datetime).tz(timezone)
const dateLabel = datetime.format('YYYY年MM月DD日 HH:mm dddd')
const timeTitle = datetime.format('YYYY/MM/DD HH:mm')
const timeago = datetime.isBefore(dayjs().subtract(1, 'w')) ? datetime.format('HH:mm · ll · ddd') : datetime.fromNow()
---

<div class="item" style={{ 'view-transition-name': `post-${post.id}` }}>
  <div class="moment">
    <figure class="moment-avatar">
      <img src={avatarSrc} alt={channelName} loading={isItem ? 'eager' : 'lazy'} />
    </figure>
    <div class="moment-content">
      <div class="moment-header">
        <span class="moment-author">{channelName}</span>
      </div>
      {post.content.length > 0 && <div class={`moment-text content`} set:html={post.content} />}
      {
        post.tags.length > 0 && (
          <div class="moment-tags">
            {post.tags.map((tag) => (
              <a href={`/search/%23${tag}`} title={tag} class="moment-tag">
                #{tag}
              </a>
            ))}
          </div>
        )
      }

      <div class="moment-footer">
        <a href={`${SITE_URL}posts/${post.id}`} title={timeago} class="moment-time-link">
          <time datetime={post.datetime} title={timeTitle} class="moment-time">{dateLabel}</time>
        </a>
      </div>

      {
        COMMENTS && isItem && (
          <div class="moment-comments">
            <script
              is:inline
              async
              src="https://telegram.org/js/telegram-widget.js"
              data-telegram-discussion={`${channel}/${post.id}`}
              data-comments-limit="50"
              data-colorful="1"
              data-color="454545"
            />
          </div>
        )
      }
    </div>
  </div>
</div>
